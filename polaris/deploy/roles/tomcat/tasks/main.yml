---
- name: Ensure create_project_directories was called before
  ansible.builtin.fail:
    msg: "Error: create_project_directories must be called before!"
  when: not role_create_project_directories_called | default(false) | bool

- name: Check Tomcat Connectivity via Proxy
  uri:
    url: "{{ tomcat_mirror }}/dist/tomcat/"
    method: GET
    status_code: 200
    return_content: no
    timeout: 10
  environment: "{{ polaris_proxy }}"
  register: tomcat_connection_check
  failed_when: tomcat_connection_check.status != 200

- name: Show Tomcat Connected Message
  debug:
    msg: "Successfully connected to Tomcat Mirror: {{ tomcat_mirror }}."

- name: Get Latest Tomcat Minor Version
  ansible.builtin.shell: "curl -s {{ tomcat_mirror }}/dist/tomcat/tomcat-{{ tomcat_major_version }}/ | grep -oP '(?<=v){{ tomcat_major_version }}\\.\\d+\\.\\d+' | sort -Vr | head -n1"
  environment: "{{ polaris_proxy }}"
  register: latest_tomcat_minor_version

- name: Set Tomcat Version number
  ansible.builtin.set_fact:
    tomcat_version: "{{ tomcat_version_number | default(latest_tomcat_minor_version.stdout, true) }}"

- name: "Show download info"
  ansible.builtin.debug:
    msg: "tomcat_major_version: {{ tomcat_major_version }} and tomcat_version: {{ tomcat_version }}"

- name: Checking for alternate app directory name
  ansible.builtin.set_fact:
    using_alt_app_dir: true
  when: alt_app_dir_name is defined

- name: "Service: stop"
  ansible.builtin.include_role:
    name: service_control
  vars:
    # If handler is 'script', you must set service_control_service_script_start and service_control_service_script_stop
    # as tomcat has it's own scripts to start/stop the server in "{{ tomcat_install_dir }}/bin/"
    service_control_action: "stop"

- meta: flush_handlers

- name: "Setup handler {{ nodejs_app_control_handler }}"
  ansible.builtin.include_role:
    name: service_control
  vars:
    service_control_action: "setup"

- name: required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0775"
  with_items:
    - "{{ tomcat_install_dir }}"
    - "{{ tomcat_data_dir }}"
    - "{{ tomcat_log_dir }}"
    - "{{ tomcat_webapp_dir }}"
  become: yes
  become_user: "{{ polaris_install_user }}"

- name: Set Tomcat Download URL
  ansible.builtin.set_fact:
    tomcat_download_url: "{{ tomcat_mirror }}/dist/tomcat/tomcat-{{ tomcat_major_version }}/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.zip"

- ansible.builtin.uri:
    url: "{{ tomcat_download_url + '.' + tomcat_checksum_protocol }}"
    return_content: true
  environment: "{{ polaris_proxy }}"
  register: tomcat_checksum

- ansible.builtin.set_fact:
    tomcat_checksum: "{{ tomcat_checksum.content.split(' ')[0] }}"      # there are 2 spaces

- name: download to {{ tomcat_download_tmp_dir }}/{{ tomcat_download_url | basename }}
  ansible.builtin.get_url:
    url: "{{ tomcat_download_url }}"
    dest: "{{ tomcat_download_tmp_dir }}/{{ tomcat_download_url | basename }}"
    checksum: "{{ tomcat_checksum_protocol }}:{{ tomcat_checksum }}"
    timeout: "{{ timeout | default(100) }}"
    mode: "0755"
  environment: "{{ polaris_proxy }}"
  become: yes
  become_user: "{{ polaris_install_user }}"

- name: load task list for Tomcat {{ tomcat_version }}
  include_tasks: "install-tomcat.yml"

- name: startup script
  ansible.builtin.template:
    src: "startup.sh.j2"
    dest: "{{ polaris_apps_service_current_home }}/startup.sh"
    mode: "0775"
  become: yes
  become_user: "{{ polaris_install_user }}"

- name: shutdown script
  ansible.builtin.template:
    src: "shutdown.sh.j2"
    dest: "{{ polaris_apps_service_current_home }}/shutdown.sh"
    mode: "0775"
  become: yes
  become_user: "{{ polaris_install_user }}"

- name: Patch intention
  include_role:
    name: patch_intention
  vars:
    _tomcat_version: "{{ tomcat_version }}"
    _tomcat_port: "{{ polaris_apps_service_port }}"
  when: polaris_broker_patch

- name: Enable rotation of catalina.out
  blockinfile:
    path: "{{ tomcat_install_dir }}/bin/catalina.sh"
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    insertafter: '= "run"'
    block: "{{ lookup('file', 'files/rotate_catalina') }}"
  become: yes
  become_user: "{{ polaris_install_user }}"

- name: "Service: start"
  ansible.builtin.include_role:
    name: service_control
  vars:
    service_control_action: "start"

- name: Mark tomcat as called
  ansible.builtin.set_fact:
    role_tomcat_called: true